<html>

  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/css/bootstrap-datepicker.css" rel="stylesheet"/>

<script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
   <link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" rel="stylesheet" type="text/css" />
     <link rel="shortcut icon" href="favicon.ico?crc=489445559"/>
      <link rel="stylesheet" href="css/fish2.css">
          <script src="js/validacionRol.js" defer></script>
    <title>Finanzas</title>
  </head>

  

  



  <div id="cover"> <div id="carga" class="loader" ></div> </div>
  
    <div id="nav-placeholder">

    </div>
  
  <br><br><br><br>


<body>

  <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-functions.js"></script>

<script src="jss/init.js"></script>
    
    <style>
        .bg {
           background-color: white;
           text-align: center;
           color: #00B0C5;
              font-size: 20px;
         }
         .bg2 {
           background-color: #00B0C5;
           text-align: center;
           color: white;
         }
       
       .badge {
   
             right: -15px;
         }
         list-group-item{
             position:relative;
         }
       
         .page, :target ~ .default {
         display: none;
     }
     
     .default, :target {
         display: block;
     }
   
     .text_nav{
       font-size:30px;
       color: azure;
       font: bold;
       text-shadow: 1px 1px 30px rgb(0, 0, 0);
     }
   
   
     .edge-danger {
       box-shadow: 0 0 11px 2px #ff0303 !important;
   }
   
   .card-danger {
       color: #fff;
       background-color: #d9534f;
       border-color: #d43f3a;
     }
     .card-success {
       color: #fff;
       background-color: #5cb85c;
       border-color: #4cae4c;
     }
   
     .carrousel_padding{
       padding:60px 60px 60px;
   
     }
   
     .center {
       margin: auto;
       width: 80%;
       
       padding: 10px;
     }
   
     .bg {
       /* The image used */
       background-color: white;
       text-align: center;
       color: #00B0C5;
       font-size: 20px;
       
     }
     .bg2 {
       /* The image used */
       background-color: #00B0C5;
       text-align: center;
       color: white;
     }
       
       .btn.btn-success {
       color: #fff;
       background-color: #00B0C5;
       border-color: #00B0C5;
     }
     .btn.btn-success.focus,
     .btn.btn-success:focus {
       color: #00B0C5;
       background-color: white;
       border-color: #00B0C5;
       outline: none;
       box-shadow: none;
     }
     .btn.btn-success:hover {
       color: #00B0C5;
       background-color: white;
       border-color: #00B0C5;
       outline: none;
       box-shadow: none;
     }
     .btn.btn-success.active,
     .btn.btn-success:active {
       color: #00B0C5;
       background-color: white;
       border-color: #00B0C5;
       outline: none;
     }
     .btn.btn-success.active.focus,
     .btn.btn-success.active:focus,
     .btn.btn-success.active:hover,
     .btn.btn-success:active.focus,
     .btn.btn-success:active:focus,
     .btn.btn-success:active:hover {
       color: #00B0C5;
       background-color: white;
       border-color: #00B0C5;
       outline: none;
       box-shadow: none;
     }
       
       #myprogressBar { 
       width: 1%;
       height: 30px;
       background-color: #00B0C5;
     } 
     
     
     </style>






<script src="https://www.gstatic.com/firebasejs/5.8.5/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyAweO2Lp7TAy6Dx94kWAwnRoaZ_N1dQSDk",
    authDomain: "caminandog-218818.firebaseapp.com",
    databaseURL: "https://caminandog-218818.firebaseio.com",
    projectId: "caminandog-218818",
    storageBucket: "caminandog-218818.appspot.com",
    messagingSenderId: "684616064893"
  };
  firebase.initializeApp(config);
</script>




<head>
    <title>Finanzas</title>
    </head>

    <div class="progress">
        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="5" aria-valuemax="100" style="width: 0%" id="myprogressBar"></div>
    </div>
<br>
    

    <!--<input type="text" id="date"><button onclick="getDates()">Get Dates</button>-->

    <div class="container">
       Start Date: <input id="startDate" width="276" />
       End Date: <input id="endDate" width="276" />


   </div>

   <br/>

   <div class="container">


      <button onclick="dispersion()" class="btn btn-success" width="276" >Dispersion </button>
      <button onclick="toxlms()" class="btn btn-success" width="276" >To xls </button>
  </div>

  <br><br>
   <script>

       $('#startDate').datepicker({
           uiLibrary: 'bootstrap4',
           iconsLibrary: 'fontawesome',
           //minDate: today,
           maxDate: function () {
               return $('#endDate').val();
           }
       });
       $('#endDate').datepicker({
           uiLibrary: 'bootstrap4',
           iconsLibrary: 'fontawesome',
           minDate: function () {
               return $('#startDate').val();
           }
       });
   </script>











<br><br>
    <div class="table-responsive">
    <table class="table table-striped" id="tabla_tabla">

        <thead class="thead-dark">
               <tr>
                 <th  scope="col">nombre</th>
                 <th  scope="col">UID</th>
                 <th  scope="col">email</th>
                 <th  scope="col">estatus</th>
                 <th  scope="col">No. perros</th>
                 <th  scope="col">Categoria</th>
                 <th  scope="col">Celular</th>
                 <th  scope="col">Telefono</th>

                </tr>
        </thead>
        <tbody id="tabla">
        </tbody>
    </table>
</div>

<div class="table-responsive">
<table class="table table-striped" id= "table_table_2" style="display: none;">
    <thead class="bg2">
           <tr>
             <th  scope="col">UID</th>
             <th  scope="col">order<br></br>id</th>
             <th  scope="col">Nombre</th>
             <th  scope="col">No.<br></br>perros</th>
             <th  scope="col">Categoria</th>
             <th  scope="col">Fecha</th>
              <th  scope="col">Inicio</th>
              <th  scope="col">Fin</th>
             <th  scope="col">monto<br></br>paseador</th>
             
            </tr>
    </thead>
    <tbody id="tabla2">
    </tbody>
</table>
</div>



<div class="chart-container" style="position: relative; height:10vh; width:20vw ;float: left" >
    <canvas style="height: 464px; width: 464px;" id="myChart" width="929" height="929"  ></canvas>

</div>

<div class="chart-container" style="position: relative; height:10vh; width:20vw ;float: left" >

    <canvas style="height: 464px; width: 464px;" id="myChart2" width="929" height="929"></canvas>
</div>

<div class="chart-container" style="position: relative; height:10vh; width:20vw ;float: left" >

    <canvas style="height: 464px; width: 464px;" id="myChart3" width="929" height="929"></canvas>
</div>







<script>

$('#tabla_tabla').hide();
$('#table_table_2').hide();
$('#btn_btn').hide();
$('#myprogressBar').hide();





/*$('#date').datepicker({
    format: "YYYY-MM-DD HH:mm",
    startView: 1,
    minViewMode: 1,
    maxViewMode: 2,
    multidate: true,
    multidateSeparator: "-",
    autoClose:true,
}).on("changeDate",function(event){
      var dates = event.dates, elem=$('#date');
      if(elem.data("selecteddates")==dates.join(",")) return; //To prevernt recursive call, that lead to lead the maximum stack in the browser.
      if(dates.length>2) dates=dates.splice(dates.length-1);
      dates.sort(function(a,b){return new Date(a).getTime()-new Date(b).getTime()});
      elem.data("selecteddates",dates.join(",")).datepicker('setDates',dates);
});*/
function update(x) { 
    var element = document.getElementById("myprogressBar");    
    var width = x; 
    var identity = setInterval(scene, 10); 
    function scene() { 
      if (width >= 100) { 
        clearInterval(identity); 
      } else { 
        //width++;  
        element.style.width = width + '%';  
      } 
    } 
  } 
  
  function update2(x) { 
    var element = document.getElementById("myprogressBar");    
    var width = 1 ; 
    var identity = setInterval(scene, 1); 
    function scene() { 
      if (width >= 100) { 
        clearInterval(identity); 
      } else { 
        width++;  
        element.style.width = width + '%';  
      } 
    } 
  } 




function dispersion() {
    $('#myprogressBar').show();
//update(100);


  $('#btn_btn').show();

  $('#tabla_tabla').hide();
  $('#table_table_2').show();
  //document.getElementById("demon").innerHTML ="wait for busqueda paseos......." ;
  

  var date1 = document.getElementById('startDate').value;
  var date2 = document.getElementById('endDate').value;
  date1 = date1+' 20:00';
  date2 = date2+' 20:00';

  var timestamp1 = moment(date1).format("X");
  var timestamp2 = moment(date2).format("X");
  timestamp1 = timestamp1*1000;
  timestamp2 = timestamp2*1000;  

  //console.log(timestamp1+" "+timestamp2)

  let lang = 'es-US' ;// you may use user's computer language: navigator.language || navigator.userLanguage
  let options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour:"numeric", minute:"numeric"};


//document.getElementById("demo").innerHTML ="Buscando: " ;
var db = firebase.database();
var ref = db.ref("Paseos_paseadores");
var ref33 = db.ref("Paseadores");

 var x = document.getElementById("tabla");
 x.style.display = "none";
var table = document.getElementById("tabla2");

//limpia la tabla
table.innerHTML = "";


 ref.on("child_added", function(snapshot){
   
   var ref2 = db.ref("Paseos_paseadores/"+snapshot.key);

   ref2.orderByChild("fin").startAt(timestamp1).endAt(timestamp2).on("child_added", function(snapshott){
     //console.log(snapshot.key+' <> '+snapshott.key+' <> '+snapshott.val().amount);
  
   
   

     var d = snapshott.val();

     var datetoshow = new Date(d.time_op*1000);

     

     ref33.orderByChild("idPaseador").equalTo(snapshot.key).on("child_added", function(snapsho){
      var de = snapsho.val();

      var fecha_inicio = new Date(d.inicio);
      var fecha_fin = new Date(d.fin);
      let lang = 'es-US' // you may use user's computer language: navigator.language || navigator.userLanguage
let options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric', hour:"numeric", minute:"numeric"};

if(de.nombre === undefined){
console.log("undefined nombre "+snapshot.key)

}

if (snapshot.key=='ACzkl7J6OJNUmBbYJGUypk6A4yy2'||snapshot.key=='TzsgVsAHV2NQklFplsvVZHGWbA63') {

}else {
  console.log(snapsho.numChildren())
  update2(snapsho.numChildren());

  {
    /*var subtotal = childData.amount/1.16;
    var iva = childData.amount-subtotal;
    var fee = childData.fee;
    var monto_caminandog = childData.amount-d.amount-iva-fee;
    var comprobacion = Math.round(d.amount * 100) / 100 + Math.round(monto_caminandog * 100) / 100 + Math.round(iva * 100) / 100 + Math.round(fee * 100) / 100;*/

    var row = table.insertRow(0);
    var cell1 = row.insertCell(0);
    var cell2 = row.insertCell(1);
    var cell3 = row.insertCell(2);
    var cell4 = row.insertCell(3);
    var cell5 = row.insertCell(4);
    var cell6 = row.insertCell(5);
    var cell7 = row.insertCell(6);
    var cell8 = row.insertCell(7);
    var cell9 = row.insertCell(8);
    /*var cell10 = row.insertCell(9);
    var cell11 = row.insertCell(10);
    var cell12 = row.insertCell(11);
    var cell13 = row.insertCell(12);
    var cell14 = row.insertCell(13);
    var cell15 = row.insertCell(14);*/
    
    
    
    var aa = moment(datetoshow).subtract(1, 'hour'); 
    var bb = moment(datetoshow).add(2, 'hour'); 

    var range2 = moment(fecha_inicio).isBetween(aa, bb); // true

    if(!range2){
     cell5.style.color = '#F27F0C';
     cell6.style.color = '#F27F0C';
     cell7.style.color = '#F27F0C';

    }

    

    





  cell1.innerHTML = snapshot.key;
  cell2.innerHTML = snapshott.key;
  cell3.innerHTML = de.nombre+" "+de.apellidopa+" "+de.apellidoma;
  cell4.innerHTML = d.num_perros;
  cell5.innerHTML = d.categoria;
  cell6.innerHTML = datetoshow.toLocaleDateString(lang, options);
  cell7.innerHTML = fecha_inicio.toLocaleDateString(lang, options);
  cell8.innerHTML = fecha_fin.toLocaleDateString(lang, options);
  
  /*cell9.innerHTML = Math.round(childData.amount * 100) / 100;
  cell10.innerHTML = Math.round(subtotal * 100) / 100;
  cell11.innerHTML = Math.round(iva * 100) / 100;
  cell12.innerHTML = Math.round(fee * 100) / 100;
  cell13.innerHTML = Math.round(monto_caminandog * 100) / 100  ;*/
  cell9.innerHTML = Math.round(d.amount * 100) / 100;
  //cell15.innerHTML = childData.id_usr;
}

}
      
       

/*ref_paseos_usrs.on("child_added", function(snap){

  snap.forEach(function(childSnapshot) {
    var childKey = childSnapshot.key;
    var childData = childSnapshot.val();
    if (childKey==snapshott.key) {

    }
  });
});*/

});//
  
    


    





   });





 });

 


}

function toxlms (){
  var date1 = document.getElementById('startDate').value;
  var date2 = document.getElementById('endDate').value;
    var downloadLink;
    var dataType = 'application/vnd.ms-excel';
    var tableSelect = document.getElementById("table_table_2");
    var tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');

    // Specify file name
    var filename = 'Dispersion de '+date1+' a '+date2;
    filename = filename?filename+'.xls':'excel_data.xls';

    // Create download link element
    downloadLink = document.createElement("a");

    document.body.appendChild(downloadLink);

    if(navigator.msSaveOrOpenBlob){
        var blob = new Blob(['ufeff', tableHTML], {
            type: dataType
        });
        navigator.msSaveOrOpenBlob( blob, filename);
    }else{
        // Create a link to the file
        downloadLink.href = 'data:' + dataType + ', ' + tableHTML;

        // Setting the file name
        downloadLink.download = filename;

        //triggering the function
        downloadLink.click();
    }
}
/*
   var uid = getAllUrlParams().uid;
   var order_id = getAllUrlParams().order_id;




function ultimo_paseo_usuario() {

  var db = firebase.database();
  var ref = db.ref("Paseos_usuarios").child(uid);

  var table = document.getElementById("tabla");

//limpia la tabla
table.innerHTML = "";


ref.orderByChild("operation_date").on("child_added", function(snapshot){


  var d = snapshot.val();

  {
    var row = table.insertRow(0);
    var cell1 = row.insertCell(0);
    var cell2 = row.insertCell(1);
    var cell3 = row.insertCell(2);
    var cell4 = row.insertCell(3);
    var cell5 = row.insertCell(4);



    // asigna a las celdas el valir del Child especificado
    cell1.innerHTML = d.id_usr;
    cell2.innerHTML = d.order_id;
    cell3.innerHTML = d.categoria;
    cell4.innerHTML = d.operation_date;


    if(d.estatusPaseo.estatus == "terminado"){

     cell5.innerHTML = '<button onclick="mostrarTrackingTerminado(\'' + d.id_usr + '\',\'' + d.order_id + '\')">Ver mas</button>';

    } else{

    cell5.innerHTML = d.estatusPaseo.estatus;

    }


    }




});

}

 window.onload = ultimo_paseo_usuario();


function mostrarTrackingTerminado(uid,order_id){
  window.open('terminado.html?uid='+uid+"&order_id="+order_id, '_blank');

}



function verpaseoshistorico(uid,order_id){
  window.open('historico.html?uid='+uid+"&order_id="+order_id, '_blank');

}




   function getAllUrlParams(url) {

  // get query string from url (optional) or window
  var queryString = url ? url.split('?')[1] : window.location.search.slice(1);

  // we'll store the parameters here
  var obj = {};

  // if query string exists
  if (queryString) {

    // stuff after # is not part of query string, so get rid of it
    queryString = queryString.split('#')[0];

    // split our query string into its component parts
    var arr = queryString.split('&');

    for (var i = 0; i < arr.length; i++) {
      // separate the keys and the values
      var a = arr[i].split('=');

      // set parameter name and value (use 'true' if empty)
      var paramName = a[0];
      var paramValue = typeof (a[1]) === 'undefined' ? true : a[1];


      if (typeof paramValue === 'string') paramValue = paramValue;

      // if the paramName ends with square brackets, e.g. colors[] or colors[2]
      if (paramName.match(/\[(\d+)?\]$/)) {

        // create key if it doesn't exist
        var key = paramName.replace(/\[(\d+)?\]/, '');
        if (!obj[key]) obj[key] = [];

        // if it's an indexed array e.g. colors[2]
        if (paramName.match(/\[\d+\]$/)) {
          // get the index value and add the entry at the appropriate position
          var index = /\[(\d+)\]/.exec(paramName)[1];
          obj[key][index] = paramValue;
        } else {
          // otherwise add the value to the end of the array
          obj[key].push(paramValue);
        }
      } else {
        // we're dealing with a string
        if (!obj[paramName]) {
          // if it doesn't exist, create property
          obj[paramName] = paramValue;
        } else if (obj[paramName] && typeof obj[paramName] === 'string'){
          // if property does exist and it's a string, convert it to an array
          obj[paramName] = [obj[paramName]];
          obj[paramName].push(paramValue);
        } else {
          // otherwise add the property
          obj[paramName].push(paramValue);
        }
      }
    }
  }

  return obj;
}*/




</script>

<script>
  
  function cerrarSesion(){

  var r = confirm("¿Estas seguro que quieres cerrar sesión?");

  if (r == true) {
          firebase.auth().signOut().then(function() {
           // Sign-out successful.
            }).catch(function(error) {
            // An error happened.
            });
  } else {


  }

}


</script>


<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.1/moment.min.js"></script>-->

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.1/moment.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

</body>
</html>
