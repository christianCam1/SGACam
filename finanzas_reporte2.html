
<html>

  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
     <link rel="shortcut icon" href="favicon.ico?crc=489445559"/>
              <link rel="stylesheet" href="css/estilos.css">

    


    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
        <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>



    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.20/datatables.min.css"/>


        <script src = "https://cdn.datatables.net/buttons/1.7.0/js/dataTables.buttons.min.js"  ></script>

        <script src = "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"  ></script>
        <script src = "https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"  ></script>

            <script src = "https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"  ></script>

                <script src = "https://cdn.datatables.net/buttons/1.7.0/js/buttons.html5.min.js"  ></script>
                    <script src = "https://cdn.datatables.net/buttons/1.7.0/js/buttons.print.min.js"  ></script>


    <script src="https://cdn.datatables.net/plug-ins/1.10.24/api/sum().js"></script>
<script src="https://cdn.datatables.net/plug-ins/1.10.24/api/sum().js"></script>
 <script src="https://cdn.datatables.net/plug-ins/1.10.24/api/fnFindCellRowIndexes.js"></script>

     <link rel="shortcut icon" href="favicon.ico?crc=489445559"/>
      <link rel="stylesheet" href="css/fish2.css">

      <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/css/bootstrap-datepicker.css" rel="stylesheet"/>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
<link href="hhttps://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css" rel="stylesheet"/>
<script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
   <link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" rel="stylesheet" type="text/css" />


 <script src="js/validacionRol.js" defer></script>
    <title>Reporte Financiero</title>
  </head>

  <div id="cover"> <div id="carga" class="loader" ></div> </div>
  
<body>


      <div id="nav-placeholder">

    </div>




  <style>
     .bg {
        background-color: white;
        text-align: center;
        color: #00B0C5;
        font-size: 20px;
      }
      .bg2 {
        background-color: #00B0C5;
        text-align: center;
        color: white;
      }
    
    .badge {

          right: -15px;
      }
      list-group-item{
          position:relative;
      }
    
      .page, :target ~ .default {
      display: none;
  }
  
  .default, :target {
      display: block;
  }

  .text_nav{
    font-size:30px;
    color: azure;
    font: bold;
    text-shadow: 1px 1px 30px rgb(0, 0, 0);
  }


  .edge-danger {
    box-shadow: 0 0 11px 2px #ff0303 !important;
}

.card-danger {
    color: #fff;
    background-color: #d9534f;
    border-color: #d43f3a;
  }
  .card-success {
    color: #fff;
    background-color: #5cb85c;
    border-color: #4cae4c;
  }

  .carrousel_padding{
    padding:60px 60px 60px;

  }

  .center {
    margin: auto;
    width: 80%;
    
    padding: 10px;
  }

  .bg {
    /* The image used */
    background-color: white;
    text-align: center;
    color: #00B0C5;
    font-size: 20px;
    
  }
  .bg2 {
    /* The image used */
    background-color: #00B0C5;
    text-align: center;
    color: white;
  }
    
    .btn.btn-success {
    color: #fff;
    background-color: #00B0C5;
    border-color: #00B0C5;
  }
  .btn.btn-success.focus,
  .btn.btn-success:focus {
    color: #00B0C5;
    background-color: white;
    border-color: #00B0C5;
    outline: none;
    box-shadow: none;
  }
  .btn.btn-success:hover {
    color: #00B0C5;
    background-color: white;
    border-color: #00B0C5;
    outline: none;
    box-shadow: none;
  }
  .btn.btn-success.active,
  .btn.btn-success:active {
    color: #00B0C5;
    background-color: white;
    border-color: #00B0C5;
    outline: none;
  }
  .btn.btn-success.active.focus,
  .btn.btn-success.active:focus,
  .btn.btn-success.active:hover,
  .btn.btn-success:active.focus,
  .btn.btn-success:active:focus,
  .btn.btn-success:active:hover {
    color: #00B0C5;
    background-color: white;
    border-color: #00B0C5;
    outline: none;
    box-shadow: none;
  }
    
    #myprogressBar { 
    width: 1%;
    height: 30px;
    background-color: #00B0C5;
  } 
  
  
  </style>



<script src="https://www.gstatic.com/firebasejs/5.8.5/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyAweO2Lp7TAy6Dx94kWAwnRoaZ_N1dQSDk",
    authDomain: "caminandog-218818.firebaseapp.com",
    databaseURL: "https://caminandog-218818.firebaseio.com",
    projectId: "caminandog-218818",
    storageBucket: "caminandog-218818.appspot.com",
    messagingSenderId: "684616064893"
  };
  firebase.initializeApp(config);
</script>


<head>

    </head>
  

  <br><br><br><br>  <br><br>


    <div class="container">
       Start Date: <input id="startDate" width="276" />
       End Date: <input id="endDate" width="276" />


   </div>
  
   <br/>
   <div class="container">


      <button onclick="dispersion()" class="btn btn-success" width="276" >Dispersion </button>

  </div>

   <br/>   <br/>
  <div class="container-fluid carrousel_padding center" id="dash">

    <div class="row">
        <div class="col-sm" style="margin-bottom:10px;">
            <div class="card ">
                <li class="list-group-item  bg2 border ">Total<br/><span class="badge badge-primary badge-pill bg " id="tot"></span></li>
            </div>
        </div>

        <div class="col-sm" style="margin-bottom:10px;">
            <div class="card ">
                <li class="list-group-item  bg2 border ">Total Paseadores<br/><span class="badge badge-primary badge-pill bg" id="tot2"></span></li>

            </div>
        </div>

        <div class="col-sm" style="margin-bottom:10px;">
            <div class="card ">
                <li class="list-group-item  bg2 border ">Total Conekta<br/><span class="badge badge-primary badge-pill bg" id="tot3"></span></li>

            </div>
        </div>

        <div class="col-sm" style="margin-bottom:10px;">
            <div class="card ">
                <li class="list-group-item  bg2 border ">Total IVA<br/><span class="badge badge-primary badge-pill bg" id="tot4"></span></li>

            </div>
        </div>

        <div class="col-sm" style="margin-bottom:10px;">
            <div class="card ">
                <li class="list-group-item  bg2 border ">Total Caminandog<br/><span class="badge badge-primary badge-pill bg" id="tot5"></span></li>

            </div>
        </div>
        <div class="col-sm" style="margin-bottom:10px;">
            <div class="card ">
                <li class="list-group-item  bg2 border "># Paseos<br/><span class="badge badge-primary badge-pill bg" id="tot6"></span></li>

            </div>
        </div>

        
    </div>
</div>




<br><br>
<div class="container-fluid">




<div class="container">






</div>


<br><br>


  <div class="table-responsive">
    <table class="table table-striped" id="tablaDatos" >
        <thead class="bg2">
               <tr>
             <th  scope="col">Order id</th>
             <th  scope="col">Fecha (Timestamp)</th>
             <th  scope="col">Fecha</th>
              <th  scope="col">Descripcion (Busqueda)</th>
             <th  scope="col">Descripcion</th>
             <th  scope="col"># Paseos</th>
             <th  scope="col">Total</th>
             <th  scope="col">Monto Paseador</th>
             <th  scope="col">Comision conekta</th>
             <th  scope="col">IVA</th>
             <th  scope="col">Monto Caminandog</th>
             <th  scope="col">Nombre</th>
             <th  scope="col">UID</th>

                </tr>
        </thead>
        <tbody id="tabla">
        </tbody>
        <tfoot>
					<tr>
			<th></th>
            <th></th>
            <th></th>
                        <th></th>
            <th></th>
            <th id="numPaseos"># Paseos</th>
            <th id="Total">Total</th>
            <th id="Monto_Paseador">Monto Paseador</th>
            <th id="Comision_conekta">Comision conekta</th>
            <th id="IVA">IVA</th>
            <th id="Monto_Caminandog">Monto Caminandog</th>
             <th></th>
            <th></th>
					</tr>
				</tfoot>
    </table>
</div>



</div>
</div>


   <script>

       $('#startDate').datepicker({
           uiLibrary: 'bootstrap4',
           iconsLibrary: 'fontawesome',
           //minDate: today,
           maxDate: function () {
               return $('#endDate').val();
           }
       });
       $('#endDate').datepicker({
           uiLibrary: 'bootstrap4',
           iconsLibrary: 'fontawesome',
           minDate: function () {
               return $('#startDate').val();
           }
       });
   </script>


<script>


var UsuariosPorTimestamp = [];
var primeraVez = true;

var consulta = "";
var texto_grafica = "";



 window.onload = crear_tabla();

function crear_tabla() {





var  tabla = $('#tablaDatos').DataTable({

			footerCallback: function ( row, data, start, end, display ) {
            var api = this.api(), data;
 
            // Remove the formatting to get integer data for summation
            var intVal = function ( i ) {
                return typeof i === 'string' ?
                    i.replace(/[\$,]/g, '')*1 :
                    typeof i === 'number' ?
                        i : 0;
            };
        },

               pagingType: "full_numbers",
               paging:   true, //Muestra la paginacion y el combobox
               bFilter: true,
        //Muestra oculta filtro
              info:     true, 


                columnDefs: [
                           { "targets": [ 1 ], "visible": false },
                            { "targets": [ 3 ], "visible": false },
                           { "orderData": 2, "targets": 1},
                            { "searchable": false, "targets": 4 }
                          ],

                "order": [[ 2, "desc" ]],

                pageLength : 10,
                lengthMenu: [[5, 10, 20, -1], [5, 10, 20, 'Todos']],

              dom: 'Bfrtip',
              buttons: [
          {
                extend: 'csvHtml5',
                footer: true,
                exportOptions: {
                    columns: [ 0,2,4,5,6,7,8,9,10,11,12]
                }
            },
            {
                "extend": 'excelHtml5',
                 "footer": true,
                "exportOptions": {
                    "columns":  [ 0,2,4,5,6,7,8,9,10,11,12]
                }
            }

              ],
 
         



                        "language": {
        "sProcessing":    "Procesando...",
        "sLengthMenu":    "Mostrar _MENU_ registros",
        "sZeroRecords":   "No se encontraron resultados",
        "sEmptyTable":    "Ningún dato disponible en esta tabla",
        "sInfo":          "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
        "sInfoEmpty":     "Mostrando registros del 0 al 0 de un total de 0 registros",
        "sInfoFiltered":  "(filtrado de un total de _MAX_ registros)",
        "sInfoPostFix":   "",
        "sSearch":        "Buscar:",
        "sUrl":           "",
        "sInfoThousands":  ",",
        "sLoadingRecords": "Cargando...",
        "oPaginate": {
            "sFirst":    "Primero",
            "sLast":    "Último",
            "sNext":    "Siguiente",
            "sPrevious": "Anterior"
        },
        "oAria": {
            "sSortAscending":  ": Activar para ordenar la columna de manera ascendente",
            "sSortDescending": ": Activar para ordenar la columna de manera descendente"
        }
    }



            });
 


   $("#cover").hide();



}



function dispersion(){



var table = $('#tablaDatos').DataTable();
table.clear()



 var total = 0;
  var total_paseador = 0;
  var total_conekta = 0;
  var total_iva = 0;
  var total_caminandog = 0;
  var total_paseos = 0;


  var date1 = document.getElementById('startDate').value;
  var date2 = document.getElementById('endDate').value;
  date1 = date1+' 00:00';
  date2 = date2+' 23:59';

  var timestamp1 = moment(date1).format("X");
  var timestamp2 = moment(date2).format("X");
  timestamp1 = timestamp1*1000;
  timestamp2 = timestamp2*1000;


var db = firebase.database();
   var ref2 = db.ref("Finanzas_test");

   ref2.orderByChild("time_op").startAt(timestamp1).endAt(timestamp2).once("value").then(snapshott => {



     var datos = snapshott.val();


 for (const property in datos) {


        var d = datos[property]

     var date = new Date(d.time_op);
     var date2 = new Date(timestamp1);
     var date3 = new Date(timestamp2);
     let lang = 'es-US' // you may use user's computer language: navigator.language || navigator.userLanguage
    let options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour:"numeric", minute:"numeric"};




     //console.log(date.toLocaleDateString(lang, options)+" "+date2.toLocaleDateString(lang, options)+" "+date3.toLocaleDateString(lang, options)+" mismos");
     //console.log("nombre "+d.nombre+" Fecha"+date.toLocaleDateString(lang, options));


    var range_times = moment(d.time_op).isBetween(timestamp1, timestamp2); // true

    if (range_times==true) {
    

      {
      
      var txt = d.descripcion;
      var numb = txt.match(/\d/g);
      numb = numb.join("");
      var result;
      switch(numb.length) {
        case 2:
          result = numb.charAt(0)*numb.charAt(1);

          break;
        case 3:
          if(numb.charAt(1)==3&&numb.charAt(2)==0){
            result = numb.charAt(0)*1;

          }else{
            result = numb.charAt(0)*numb.charAt(1)*numb.charAt(2);

          }
          break;
        case 4:
          if(numb.charAt(2)==3&&numb.charAt(3)==0){
            result = numb.charAt(0)*numb.charAt(1);

          }else{
            result = (numb.charAt(0)+numb.charAt(1))*numb.charAt(2)*numb.charAt(3);

          }
          
          break;
        case 5:
          result = (numb.charAt(0)+numb.charAt(1))*numb.charAt(2);

          break;
        default:
          //cell4.innerHTML = "algo falló";
          result = numb.charAt(0)*numb.charAt(1)*1;

      }



   //   console.log(numb+" "+d.order_id+" "+result)


var descripcion_busqueda = ""

if(d.descripcion.includes("hora") || d.descripcion.includes("min") ){

    if(d.descripcion.includes("Paquete")){

        descripcion_busqueda = "Paquetes"
    } else{

        descripcion_busqueda = "Paseos al momento"

    }
} else if(d.descripcion.includes("año")){

        descripcion_busqueda = "Vigencias"


}else if(d.descripcion.includes("Plaquita")){

        descripcion_busqueda = "Placas Plaquitas"
}

               var informacionUsuarios = 

                 [

                         d.order_id,
                         d.time_op,
                         date.toLocaleDateString(lang, options),
                         descripcion_busqueda,
                         d.descripcion,
                         result,
                         Math.round(d.amount * 100) / 100,
                         Math.round(d.amount_paseador * 100) / 100,
                         Math.round(d.fee * 100) / 100,
                         Math.round(d.iva * 100) / 100,
                         Math.round(d.monto_caminandog * 100) / 100,
                         d.nombre,
                         d.uid

                ]



       

 
      table.rows.add([informacionUsuarios]);
   

    }

    }


} //fin for

habilitar_cambios_busqueda()
   table.draw()

   });



}



      
      function formatMoney(number, decPlaces, decSep, thouSep) {
        decPlaces = isNaN(decPlaces = Math.abs(decPlaces)) ? 2 : decPlaces,
        decSep = typeof decSep === "undefined" ? "." : decSep;
        thouSep = typeof thouSep === "undefined" ? "," : thouSep;
        var sign = number < 0 ? "-" : "";
        var i = String(parseInt(number = Math.abs(Number(number) || 0).toFixed(decPlaces)));
        var j = (j = i.length) > 3 ? j % 3 : 0;

        return sign +
          (j ? i.substr(0, j) + thouSep : "") +
          i.substr(j).replace(/(\decSep{3})(?=\decSep)/g, "$1" + thouSep) +
          (decPlaces ? decSep + Math.abs(number - i).toFixed(decPlaces).slice(2) : "");
        }


function ver_detalle(clave) {


  window.open('casillaDetalle.html?clave='+clave+'&ref='+consulta, '_blank');

}



function habilitar_cambios_busqueda(){

  var table = $('#tablaDatos').DataTable();
 
table.on( 'search.dt', function () {
   
   sumar_dibujar_grafica();

} );


}



function sumar_dibujar_grafica(){


     var sum = $('#tablaDatos').DataTable().column( 5, {"filter": "applied"} ).data().sum();
        $('#numPaseos').html(Math.round(sum * 100) / 100);

    var sum2 = $('#tablaDatos').DataTable().column( 6, {"filter": "applied"} ).data().sum();
        $('#Total').html(Math.round(sum2 * 100) / 100);

    var sum3 = $('#tablaDatos').DataTable().column( 7, {"filter": "applied"} ).data().sum();
        $('#Monto_Paseador').html(Math.round(sum3 * 100) / 100);

     var sum4 = $('#tablaDatos').DataTable().column( 8, {"filter": "applied"} ).data().sum();
        $('#Comision_conekta').html(Math.round(sum4 * 100) / 100);

     var sum5 = $('#tablaDatos').DataTable().column( 9, {"filter": "applied"} ).data().sum();
        $('#IVA').html(Math.round(sum5 * 100) / 100);

     var sum6 = $('#tablaDatos').DataTable().column( 10, {"filter": "applied"} ).data().sum();
        $('#Monto_Caminandog').html(Math.round(sum6 * 100) / 100);


      document.getElementById("tot6").innerHTML =sum 
      document.getElementById("tot").innerHTML ="$ "+formatMoney(Math.round(sum2 * 100) / 100);
      document.getElementById("tot2").innerHTML ="$ "+formatMoney(Math.round(sum3 * 100) / 100);
      document.getElementById("tot3").innerHTML ="$ "+formatMoney(Math.round(sum4 * 100) / 100 );
      document.getElementById("tot4").innerHTML ="$ "+formatMoney(Math.round(sum5 * 100) / 100); 
      document.getElementById("tot5").innerHTML ="$ "+formatMoney(Math.round(sum6 * 100) / 100);
}





</script>



<script>
  
  function cerrarSesion(){

  var r = confirm("¿Estas seguro que quieres cerrar sesión?");

  if (r == true) {
          firebase.auth().signOut().then(function() {
           // Sign-out successful.
            }).catch(function(error) {
            // An error happened.
            });
  } else {


  }

}


</script>



<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.1/moment.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

</body>
</html>
