<html>

  <head>
    
    
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/css/bootstrap-datepicker.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
<link href="hhttps://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css" rel="stylesheet"/>
<script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
   <link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" rel="stylesheet" type="text/css" />
     <link rel="shortcut icon" href="favicon.ico?crc=489445559"/>
      <link rel="stylesheet" href="css/fish2.css">
    <title>Reporte Financiero</title>
  </head>
    <script src="js/validacionRol.js" defer></script>


  <div id="cover"> <div id="carga" class="loader" ></div> </div>
  
      <div id="nav-placeholder">

    </div>

  
  <br><br><br><br>


<body>
  
  <style>
     .bg {
        background-color: white;
        text-align: center;
        color: #00B0C5;
       	font-size: 20px;
      }
      .bg2 {
        background-color: #00B0C5;
        text-align: center;
        color: white;
      }
    
    .badge {

          right: -15px;
      }
      list-group-item{
          position:relative;
      }
    
      .page, :target ~ .default {
      display: none;
  }
  
  .default, :target {
      display: block;
  }

  .text_nav{
    font-size:30px;
    color: azure;
    font: bold;
    text-shadow: 1px 1px 30px rgb(0, 0, 0);
  }


  .edge-danger {
    box-shadow: 0 0 11px 2px #ff0303 !important;
}

.card-danger {
    color: #fff;
    background-color: #d9534f;
    border-color: #d43f3a;
  }
  .card-success {
    color: #fff;
    background-color: #5cb85c;
    border-color: #4cae4c;
  }

  .carrousel_padding{
    padding:60px 60px 60px;

  }

  .center {
    margin: auto;
    width: 80%;
    
    padding: 10px;
  }

  .bg {
    /* The image used */
    background-color: white;
    text-align: center;
    color: #00B0C5;
    font-size: 20px;
    
  }
  .bg2 {
    /* The image used */
    background-color: #00B0C5;
    text-align: center;
    color: white;
  }
    
    .btn.btn-success {
    color: #fff;
    background-color: #00B0C5;
    border-color: #00B0C5;
  }
  .btn.btn-success.focus,
  .btn.btn-success:focus {
    color: #00B0C5;
    background-color: white;
    border-color: #00B0C5;
    outline: none;
    box-shadow: none;
  }
  .btn.btn-success:hover {
    color: #00B0C5;
    background-color: white;
    border-color: #00B0C5;
    outline: none;
    box-shadow: none;
  }
  .btn.btn-success.active,
  .btn.btn-success:active {
    color: #00B0C5;
    background-color: white;
    border-color: #00B0C5;
    outline: none;
  }
  .btn.btn-success.active.focus,
  .btn.btn-success.active:focus,
  .btn.btn-success.active:hover,
  .btn.btn-success:active.focus,
  .btn.btn-success:active:focus,
  .btn.btn-success:active:hover {
    color: #00B0C5;
    background-color: white;
    border-color: #00B0C5;
    outline: none;
    box-shadow: none;
  }
    
    #myprogressBar { 
    width: 1%;
    height: 30px;
    background-color: #00B0C5;
  } 
  
  
  </style>






<script src="https://www.gstatic.com/firebasejs/5.8.5/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyAweO2Lp7TAy6Dx94kWAwnRoaZ_N1dQSDk",
    authDomain: "caminandog-218818.firebaseapp.com",
    databaseURL: "https://caminandog-218818.firebaseio.com",
    projectId: "caminandog-218818",
    storageBucket: "caminandog-218818.appspot.com",
    messagingSenderId: "684616064893"
  };
  firebase.initializeApp(config);
</script>




<head>
    <title>Finanzas</title>
    </head>

    <div class="progress">
    	<div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="5" aria-valuemax="100" style="width: 0%" id="myprogressBar"></div>
	</div>
  <br>

    <!--<input type="text" id="date"><button onclick="getDates()">Get Dates</button>-->

    <div class="container">
       Start Date: <input id="startDate" width="276" />
       End Date: <input id="endDate" width="276" />


   </div>
  
  <br/>

   <div class="container">

      <button onclick="dispersion()" class="btn btn-success" width="276"  >Consultar </button>
      <button onclick="toxlms()" class="btn btn-success" width="276" id="btn_btn" >To xls </button>
  </div>
  
  <br><br>
  
  <div class="container-fluid carrousel_padding center" id="dash">

    <div class="row">
        <div class="col-sm" style="margin-bottom:10px;">
            <div class="card ">
                <li class="list-group-item  bg2 border ">Total<br/><span class="badge badge-primary badge-pill bg " id="tot"></span></li>
            </div>
        </div>

        <div class="col-sm" style="margin-bottom:10px;">
            <div class="card ">
                <li class="list-group-item  bg2 border ">Total Paseadores<br/><span class="badge badge-primary badge-pill bg" id="tot2"></span></li>

            </div>
        </div>

        <div class="col-sm" style="margin-bottom:10px;">
            <div class="card ">
                <li class="list-group-item  bg2 border ">Total Conekta<br/><span class="badge badge-primary badge-pill bg" id="tot3"></span></li>

            </div>
        </div>

        <div class="col-sm" style="margin-bottom:10px;">
            <div class="card ">
                <li class="list-group-item  bg2 border ">Total IVA<br/><span class="badge badge-primary badge-pill bg" id="tot4"></span></li>

            </div>
        </div>

        <div class="col-sm" style="margin-bottom:10px;">
            <div class="card ">
                <li class="list-group-item  bg2 border ">Total Caminandog<br/><span class="badge badge-primary badge-pill bg" id="tot5"></span></li>

            </div>
        </div>
        <div class="col-sm" style="margin-bottom:10px;">
            <div class="card ">
                <li class="list-group-item  bg2 border "># Paseos<br/><span class="badge badge-primary badge-pill bg" id="tot6"></span></li>

            </div>
        </div>

        
    </div>
</div>


  
  
 
   <script>

       $('#startDate').datepicker({
           uiLibrary: 'bootstrap4',
           iconsLibrary: 'fontawesome',
           //minDate: today,
           maxDate: function () {
               return $('#endDate').val();
           }
       });
       $('#endDate').datepicker({
           uiLibrary: 'bootstrap4',
           iconsLibrary: 'fontawesome',
           minDate: function () {
               return $('#startDate').val();
           }
       });
   </script>


<br><br>
    <div class="table-responsive">
    <table class="table table-striped" id="tabla_tabla">

        <thead class="thead-dark">
               <tr>
                 <th  scope="col">nombre</th>
                 <th  scope="col">UID</th>
                 <th  scope="col">email</th>
                 <th  scope="col">estatus</th>
                 <th  scope="col">No. perros</th>
                 <th  scope="col">Categoria</th>
                 <th  scope="col">Celular</th>
                 <th  scope="col">Telefono</th>

                </tr>
        </thead>
        <tbody id="tabla">
        </tbody>
    </table>
</div>

<div class="table-responsive ">
<table class="table table-striped" id= "table_table_2" >
    <thead class="bg2">
           <tr>
             <th  scope="col">Order id</th>
             <th  scope="col">Fecha</th>
             <th  scope="col">Descripcion</th>
             <th  scope="col"># Paseos</th>
             <th  scope="col">Total</th>
             <th  scope="col">Monto Paseador</th>
             <th  scope="col">Comision conekta</th>
             <th  scope="col">IVA</th>
             <th  scope="col">Monto Caminandog</th>
             <th  scope="col">Nombre</th>
             <th  scope="col">UID</th>
            </tr>
    </thead>
    <tbody id="tabla2">
    </tbody>
</table>
</div>











<script>
$('#tabla_tabla').hide();
$('#table_table_2').hide();
$('#dash').hide();
$('#btn_btn').hide();
$('#myprogressBar').hide();





/*$('#date').datepicker({
    format: "YYYY-MM-DD HH:mm",
    startView: 1,
    minViewMode: 1,
    maxViewMode: 2,
    multidate: true,
    multidateSeparator: "-",
    autoClose:true,
}).on("changeDate",function(event){
      var dates = event.dates, elem=$('#date');
      if(elem.data("selecteddates")==dates.join(",")) return; //To prevernt recursive call, that lead to lead the maximum stack in the browser.
      if(dates.length>2) dates=dates.splice(dates.length-1);
      dates.sort(function(a,b){return new Date(a).getTime()-new Date(b).getTime()});
      elem.data("selecteddates",dates.join(",")).datepicker('setDates',dates);
});*/

function update(x) { 
    var element = document.getElementById("myprogressBar");    
    var width = x; 
    var identity = setInterval(scene, 10); 
    function scene() { 
      if (width >= 100) { 
        clearInterval(identity); 
      } else { 
        //width++;  
        element.style.width = width + '%';  
      } 
    } 
  } 
  
  function update2() { 
    var element = document.getElementById("myprogressBar");    
    var width = 1; 
    var identity = setInterval(scene, 20); 
    function scene() { 
      if (width >= 100) { 
        clearInterval(identity); 
      } else { 
        width++;  
        element.style.width = width + '%';  
      } 
    } 
  } 




function dispersion() {
$('#myprogressBar').show();
update(100);

  var total = 0;
  var total_paseador = 0;
  var total_conekta = 0;
  var total_iva = 0;
  var total_caminandog = 0;
  var total_paseos = 0;

  $('#tabla_tabla').hide();
  $('#table_table_2').show();
  $('#dash').show();
  $('#btn_btn').show();
  //document.getElementById("demon").innerHTML ="wait for busqueda paseos......." ;

  var date1 = document.getElementById('startDate').value;
  var date2 = document.getElementById('endDate').value;
  date1 = date1+' 00:00';
  date2 = date2+' 23:59';

  var timestamp1 = moment(date1).format("X");
  var timestamp2 = moment(date2).format("X");
  timestamp1 = timestamp1*1000;
  timestamp2 = timestamp2*1000;


//document.getElementById("demo").innerHTML ="Buscando: " ;
var db = firebase.database();

 var x = document.getElementById("tabla");
 x.style.display = "none";
var table = document.getElementById("tabla2");

table.innerHTML = "";




   var ref2 = db.ref("Finanzas");

   ref2.orderByChild("time_op").startAt(timestamp1).endAt(timestamp2).on("child_added", function(snapshott){

   //document.getElementById("demon").innerHTML =snapshott.val() ;

   var exist = snapshott.val();
   if (exist == null) {
   //document.getElementById("demon").innerHTML ="no encontrado" ;
   $('.progress-bar').css('width', 80+'%').attr('aria-valuenow', 80);
	$('#myprogressBar').hide();
   }else{
   //document.getElementById("demon").innerHTML ="encontrado" ;
  

   }

     var d = snapshott.val();

     var date = new Date(d.time_op);
     var date2 = new Date(timestamp1);
     var date3 = new Date(timestamp2);
     let lang = 'es-US' // you may use user's computer language: navigator.language || navigator.userLanguage
    let options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour:"numeric", minute:"numeric"};




     //console.log(date.toLocaleDateString(lang, options)+" "+date2.toLocaleDateString(lang, options)+" "+date3.toLocaleDateString(lang, options)+" mismos");
     //console.log("nombre "+d.nombre+" Fecha"+date.toLocaleDateString(lang, options));


    var range_times = moment(d.time_op).isBetween(timestamp1, timestamp2); // true

    if (range_times==true) {
    
    update2();
    //$('#myprogressBar').hide();

      {


        var row = table.insertRow(0);
        var cell1 = row.insertCell(0);
        var cell2 = row.insertCell(1);
        var cell3 = row.insertCell(2);
        var cell4 = row.insertCell(3);
        var cell5 = row.insertCell(4);
        var cell6 = row.insertCell(5);
        var cell7 = row.insertCell(6);
        var cell8 = row.insertCell(7);
        var cell9 = row.insertCell(8);
        var cell10 = row.insertCell(9);
        var cell11 = row.insertCell(10);

      cell1.innerHTML = d.order_id;
      cell2.innerHTML = date.toLocaleDateString(lang, options);
      cell3.innerHTML = d.descripcion;
      
      var txt = d.descripcion;
      var numb = txt.match(/\d/g);
      numb = numb.join("");
      var result;
      switch(numb.length) {
        case 2:
          result = numb.charAt(0)*numb.charAt(1);
          cell4.innerHTML = result;
          break;
        case 3:
          if(numb.charAt(1)==3&&numb.charAt(2)==0){
            result = numb.charAt(0)*1;
            cell4.innerHTML = result;
          }else{
            result = numb.charAt(0)*numb.charAt(1)*numb.charAt(2);
            cell4.innerHTML = result;
          }
          break;
        case 4:
          if(numb.charAt(2)==3&&numb.charAt(3)==0){
            result = numb.charAt(0)*numb.charAt(1);
            cell4.innerHTML = result;
          }else{
            result = (numb.charAt(0)+numb.charAt(1))*numb.charAt(2)*numb.charAt(3);
            cell4.innerHTML = result;
          }
          
          break;
        case 5:
          result = (numb.charAt(0)+numb.charAt(1))*numb.charAt(2);
          cell4.innerHTML = result;
          break;
        default:
          //cell4.innerHTML = "algo falló";
          result = numb.charAt(0)*numb.charAt(1)*1;
          cell4.innerHTML = result;
      }
      console.log(numb+" "+d.order_id+" "+result)
      cell5.innerHTML = Math.round(d.amount * 100) / 100;
      cell6.innerHTML = Math.round(d.amount_paseador * 100) / 100;
      cell7.innerHTML = Math.round(d.fee * 100) / 100;
      cell8.innerHTML = Math.round(d.iva * 100) / 100;
      cell9.innerHTML = Math.round(d.monto_caminandog * 100) / 100;
      cell10.innerHTML = d.nombre;
      cell11.innerHTML = d.uid;
      //cell11.innerHTML = Math.round(d.monto_caminandog * 100) / 100  ;
      //cell12.innerHTML = Math.round(d.amount * 100) / 100;


      total = total+Math.round(d.amount * 100) / 100;
      total_paseador = total_paseador+Math.round(d.amount_paseador * 100) / 100;
      total_conekta = total_conekta+Math.round(d.fee * 100) / 100;
      total_iva = total_iva+Math.round(d.iva * 100) / 100;
      total_caminandog = total_caminandog+Math.round(d.monto_caminandog * 100) / 100;
      total_paseos = total_paseos+result
      
      

      document.getElementById("tot").innerHTML ="$ "+formatMoney(Math.round(total * 100) / 100);
      document.getElementById("tot2").innerHTML ="$ "+formatMoney(Math.round(total_paseador * 100) / 100);
      document.getElementById("tot3").innerHTML ="$ "+formatMoney(Math.round(total_conekta * 100) / 100);
      document.getElementById("tot4").innerHTML ="$ "+formatMoney(Math.round(total_iva * 100) / 100 );
      document.getElementById("tot5").innerHTML ="$ "+formatMoney(Math.round(total_caminandog * 100) / 100); 
      document.getElementById("tot6").innerHTML =total_paseos;
      
      $('#myBar').hide();
      
      function formatMoney(number, decPlaces, decSep, thouSep) {
        decPlaces = isNaN(decPlaces = Math.abs(decPlaces)) ? 2 : decPlaces,
        decSep = typeof decSep === "undefined" ? "." : decSep;
        thouSep = typeof thouSep === "undefined" ? "," : thouSep;
        var sign = number < 0 ? "-" : "";
        var i = String(parseInt(number = Math.abs(Number(number) || 0).toFixed(decPlaces)));
        var j = (j = i.length) > 3 ? j % 3 : 0;

        return sign +
          (j ? i.substr(0, j) + thouSep : "") +
          i.substr(j).replace(/(\decSep{3})(?=\decSep)/g, "$1" + thouSep) +
          (decPlaces ? decSep + Math.abs(number - i).toFixed(decPlaces).slice(2) : "");
        }

        document.getElementById("b").addEventListener("click", event => {
        document.getElementById("x").innerText = "Result was: " + formatMoney(document.getElementById("d").value);
  
  
  
});
      
      
    }

    }


     //console.log("<-------------->");


     //console.log(">--------------<");





   });


}



function toxlms (){
  var date1 = document.getElementById('startDate').value;
  var date2 = document.getElementById('endDate').value;
    var downloadLink;
    var dataType = 'application/vnd.ms-excel';
    var tableSelect = document.getElementById("table_table_2");
    var tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');

    // Specify file name
    var filename = 'Reporte finanzas '+date1+' a '+date2;
    filename = filename?filename+'.xls':'excel_data.xls';

    // Create download link element
    downloadLink = document.createElement("a");

    document.body.appendChild(downloadLink);

    if(navigator.msSaveOrOpenBlob){
        var blob = new Blob(['ufeff', tableHTML], {
            type: dataType
        });
        navigator.msSaveOrOpenBlob( blob, filename);
    }else{
        // Create a link to the file
        downloadLink.href = 'data:' + dataType + ', ' + tableHTML;

        // Setting the file name
        downloadLink.download = filename;

        //triggering the function
        downloadLink.click();
    }
}

   var uid = getAllUrlParams().uid;
   var order_id = getAllUrlParams().order_id;




function ultimo_paseo_usuario() {

  var db = firebase.database();
  var ref = db.ref("Paseos_usuarios").child(uid);

  var table = document.getElementById("tabla");

//limpia la tabla
table.innerHTML = "";


ref.orderByChild("operation_date").on("child_added", function(snapshot){


  var d = snapshot.val();

  {
    var row = table.insertRow(0);
    var cell1 = row.insertCell(0);
    var cell2 = row.insertCell(1);
    var cell3 = row.insertCell(2);
    var cell4 = row.insertCell(3);
    var cell5 = row.insertCell(4);



    // asigna a las celdas el valir del Child especificado
    cell1.innerHTML = d.id_usr;
    cell2.innerHTML = d.order_id;
    cell3.innerHTML = d.categoria;
    cell4.innerHTML = d.operation_date;


    if(d.estatusPaseo.estatus == "terminado"){

     cell5.innerHTML = '<button onclick="mostrarTrackingTerminado(\'' + d.id_usr + '\',\'' + d.order_id + '\')">Ver mas</button>';

    } else{

    cell5.innerHTML = d.estatusPaseo.estatus;

    }


    }




});

}

 window.onload = ultimo_paseo_usuario();


function mostrarTrackingTerminado(uid,order_id){
  window.open('terminado.html?uid='+uid+"&order_id="+order_id, '_blank');

}



function verpaseoshistorico(uid,order_id){
  window.open('historico.html?uid='+uid+"&order_id="+order_id, '_blank');

}




   function getAllUrlParams(url) {

  // get query string from url (optional) or window
  var queryString = url ? url.split('?')[1] : window.location.search.slice(1);

  // we'll store the parameters here
  var obj = {};

  // if query string exists
  if (queryString) {

    // stuff after # is not part of query string, so get rid of it
    queryString = queryString.split('#')[0];

    // split our query string into its component parts
    var arr = queryString.split('&');

    for (var i = 0; i < arr.length; i++) {
      // separate the keys and the values
      var a = arr[i].split('=');

      // set parameter name and value (use 'true' if empty)
      var paramName = a[0];
      var paramValue = typeof (a[1]) === 'undefined' ? true : a[1];


      if (typeof paramValue === 'string') paramValue = paramValue;

      // if the paramName ends with square brackets, e.g. colors[] or colors[2]
      if (paramName.match(/\[(\d+)?\]$/)) {

        // create key if it doesn't exist
        var key = paramName.replace(/\[(\d+)?\]/, '');
        if (!obj[key]) obj[key] = [];

        // if it's an indexed array e.g. colors[2]
        if (paramName.match(/\[\d+\]$/)) {
          // get the index value and add the entry at the appropriate position
          var index = /\[(\d+)\]/.exec(paramName)[1];
          obj[key][index] = paramValue;
        } else {
          // otherwise add the value to the end of the array
          obj[key].push(paramValue);
        }
      } else {
        // we're dealing with a string
        if (!obj[paramName]) {
          // if it doesn't exist, create property
          obj[paramName] = paramValue;
        } else if (obj[paramName] && typeof obj[paramName] === 'string'){
          // if property does exist and it's a string, convert it to an array
          obj[paramName] = [obj[paramName]];
          obj[paramName].push(paramValue);
        } else {
          // otherwise add the property
          obj[paramName].push(paramValue);
        }
      }
    }
  }

  return obj;
}




</script>



<script>
  
  function cerrarSesion(){

  var r = confirm("¿Estas seguro que quieres cerrar sesión?");

  if (r == true) {
          firebase.auth().signOut().then(function() {
           // Sign-out successful.
            }).catch(function(error) {
            // An error happened.
            });
  } else {


  }

}


</script>

<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.1/moment.min.js"></script>-->

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.1/moment.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

</body>
</html