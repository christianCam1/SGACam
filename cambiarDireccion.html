<!DOCTYPE HTML>
<html>
  <head>
    <title>Cambiar dirección</title>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>

    <!-- RSVP -->
    <script src="https://unpkg.com/rsvp@3.1.0/dist/rsvp.min.js"></script>

    <!-- GeoFire -->
    <script src="https://cdn.firebase.com/libs/geofire/4.1.0/geofire.min.js"></script>



    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/fish2.css">
    <script src="js/validacionRol.js" defer></script>

<!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
     <link rel="shortcut icon" href="favicon.ico?crc=489445559"/>

         <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAweO2Lp7TAy6Dx94kWAwnRoaZ_N1dQSDk&callback=initMap&libraries=places&v=weekly"
      
    ></script>



  </head>


<div id="cover"> <div id="carga" class="loader" ></div> </div>

  <body>
    <div id="nav-placeholder">

    </div>

  
  <br><br>

    <style type="text/css">
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */

      /* Optional: Makes the sample page fill the window. */
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #description {
        font-family: Roboto;
        font-size: 15px;
        font-weight: 300;
      }

      #infowindow-content .title {
        font-weight: bold;
      }

      #infowindow-content {
        display: none;
      }

      #map #infowindow-content {
        display: inline;
      }

      .pac-card {
        margin: 10px 10px 0 0;
        border-radius: 2px 0 0 2px;
        box-sizing: border-box;
        -moz-box-sizing: border-box;
        outline: none;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        background-color: #fff;
        font-family: Roboto;
      }

      #pac-container {
        padding-bottom: 12px;
        margin-right: 12px;
      }

      .pac-controls {
        display: inline-block;
        padding: 5px 11px;
      }

      .pac-controls label {
        font-family: Roboto;
        font-size: 13px;
        font-weight: 300;
      }

      #pac-input {
        background-color: #fff;
        font-family: Roboto;
        font-size: 15px;
        font-weight: 300;
        margin-left: 12px;
        padding: 0 11px 0 13px;
        text-overflow: ellipsis;
        width: 400px;
      }

      #pac-input:focus {
        border-color: #4d90fe;
      }

      #title {
        color: #fff;
        background-color: #4d90fe;
        font-size: 25px;
        font-weight: 500;
        padding: 6px 12px;
      }


 .demo-non-form {
    color: initial;
    width: 100%;
    padding: 10px;
    margin: 6px 0 12px 0;
    border: 1px solid #ccc;
    border-radius: 0;
    font-family: arial, verdana, sans-serif;
    font-size: 14px;
    box-sizing: border-box;
    -webkit-appearance: none;
}

.external-container button.external-button {
    font-weight: 400;
    padding: 10px;
    margin: 6px 0 13px 0;
    width: 100%;
}

    </style>

<script src="https://www.gstatic.com/firebasejs/5.8.5/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyAweO2Lp7TAy6Dx94kWAwnRoaZ_N1dQSDk",
    authDomain: "caminandog-218818.firebaseapp.com",
    databaseURL: "https://caminandog-218818.firebaseio.com",
    projectId: "caminandog-218818",
    storageBucket: "caminandog-218818.appspot.com",
    messagingSenderId: "684616064893"
  };
  firebase.initializeApp(config);
</script>


<div class="container">

    <div class="pac-card" id="pac-card">
      <div>
        <div id="title">Buscar</div>

      </div>
      <div id="pac-container">
        <input id="pac-input" type="text" placeholder="Introduce una dirección" />
      </div>
    </div>
     <div id="map" style="width:100%;height:500px;text-align:center"></div>
    <div id="infowindow-content">
      <img src="" width="16" height="16" id="place-icon" />
      <span id="place-name" class="title"></span><br />
      <span id="place-address"></span>
    </div>


<br>


  <div class="form-group">
    <label for="numInterior" id="numInteriorLabel">Número Interior</label>
    <input type="text" class="form-control" id= "numInterior" name="numInterior" placeholder="Ingresa el número interior"/>
  </div>


            <div class="row">  


<div class="col-sm-4 ">

    </div>

    <div class="col-sm-4 ">

    </div>

<div class="col-sm-4 ">

<div class="card border-0" >

      <body>

<button class="custom-button" id="siguiente" onclick="guardar_cambios()">Guardar cambios</button>

</body>
</div>

</div>

</div>



</div>


<br><br>



    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.1/locale/es.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css">


    <script>




   var order_id = getAllUrlParams().order_id;
   var latitud = parseFloat(getAllUrlParams().latitud);
   var longitud = parseFloat(getAllUrlParams().longitud);
   var fuente  = getAllUrlParams().fuente



      function cargarMapa() {



        const map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: latitud, lng: longitud },
          zoom: 17,
        });

          colormarker2 = "http://maps.google.com/mapfiles/ms/micons/blue.png";

          Markermio = new google.maps.Marker({
           animation: google.maps.Animation.DROP,
          position: { lat: latitud, lng: longitud},
          icon:colormarker2,
          draggable:true,
          map: map
          });


            google.maps.event.addListener(Markermio,'dragend',function()

  {

        console.log("dragend "+Markermio.getPosition());


    var latitud = Markermio.getPosition().lat();
  var longitud = Markermio.getPosition().lng();

        geocodeLatLng(latitud,longitud,map);

        
  })


        const card = document.getElementById("pac-card");
        const input = document.getElementById("pac-input");
        map.controls[google.maps.ControlPosition.TOP_RIGHT].push(card);
        const autocomplete = new google.maps.places.Autocomplete(input);
        // Bind the map's bounds (viewport) property to the autocomplete object,
        // so that the autocomplete requests use the current map bounds for the
        // bounds option in the request.
        autocomplete.bindTo("bounds", map);
        // Set the data fields to return when the user selects a place.
        autocomplete.setFields([
          "address_components",
          "geometry",
          "icon",
          "name",
        ]);
        const infowindow = new google.maps.InfoWindow();
        const infowindowContent = document.getElementById("infowindow-content");
        infowindow.setContent(infowindowContent);
        const marker = new google.maps.Marker({
          map,
          anchorPoint: new google.maps.Point(0, -29),
        });
        autocomplete.addListener("place_changed", () => {
          infowindow.close();
          marker.setVisible(false);
          const place = autocomplete.getPlace();

          if (!place.geometry) {
            // User entered the name of a Place that was not suggested and
            // pressed the Enter key, or the Place Details request failed.
            window.alert(
              "No details available for input: '" + place.name + "'"
            );
            return;
          }

          // If the place has a geometry, then present it on a map.
          if (place.geometry.viewport) {
            map.fitBounds(place.geometry.viewport);
          } else {
            map.setCenter(place.geometry.location);
            map.setZoom(17); // Why 17? Because it looks good.
          }

          colormarker2 = "http://maps.google.com/mapfiles/ms/micons/blue.png";

          Markermio.setPosition(place.geometry.location);



          let address = "";

          if (place.address_components) {
            address = [
              (place.address_components[0] &&
                place.address_components[0].short_name) ||
                "",
              (place.address_components[1] &&
                place.address_components[1].short_name) ||
                "",
              (place.address_components[2] &&
                place.address_components[2].short_name) ||
                "",
            ].join(" ");
          }
          infowindowContent.children["place-icon"].src = place.icon;
          infowindowContent.children["place-name"].textContent = place.name;
          infowindowContent.children["place-address"].textContent = address;
          infowindow.open(map, marker);
        });


      }



      function geocodeLatLng(lat,lng, map) {
           const geocoder = new google.maps.Geocoder();

        const latlng = {
          lat: lat,
          lng: lng,
        };

        map.setCenter({lat:lat, lng:lng});
        geocoder.geocode({ location: latlng }, (results, status) => {
          if (status === "OK") {
            if (results[0]) {
              map.setZoom(17);


              console.log(results[0].formatted_address)

              document.getElementById("pac-input").value = results[0].formatted_address;


            } else {
              window.alert("No results found");
            }
          } else {
            window.alert("Geocoder failed due to: " + status);
          }
        });
      }






function guardar_cambios() {


var numInterior = document.getElementById("numInterior").value
var direccion  = document.getElementById("pac-input").value


		 if(numInterior.trim() == ""){


		 	   alert("Numero Interior no puede estar vacio");

		 } else if(numInterior.indexOf(';') > -1){

        alert("Numero Interior no puede incluir ;");

      } else if(direccion.trim() == ""){


         alert("Necesita ingresar una dirección");

     }else{


    var db = firebase.database();
    var ref;
    var redirigir = ""
		var uid;
    
            if(fuente == "agenda"){

                ref = db.ref("Agendados").child(order_id);
                redirigir = "agenda.html"

            } else if(fuente == "paseos"){

               uid  = getAllUrlParams().uid
               ref = db.ref("Paseos_usuarios").child(uid).child(order_id);
                redirigir = "paseosActivos.html"

            }

              ref.update({ 
                 direccion: direccion+";"+numInterior,
                latitud: Markermio.getPosition().lat(),
                longitud: Markermio.getPosition().lng(),

                }).then(function() {
    

                           var key = db.ref("cambios_ordenes").push().getKey();
        var agendadosModificaciones = db.ref("cambios_ordenes");
        var currentUID = firebase.auth().currentUser.uid;


                        agendadosModificaciones.child(key).update({ 

                id_orden: order_id,
                uid: currentUID,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                cambio: "Cambio de direccion "+fuente,
                inicial: "lat: "+latitud+" lng: "+longitud,
                final: "lat: "+Markermio.getPosition().lat()+" lng: "+Markermio.getPosition().lng()

               })


              if(confirm("La direccion se ha modificado correctamente")) {
                 window.location.href = redirigir
            } else{

                window.location.href = redirigir
            }

		 })

	
}

}










function getAllUrlParams(url) {

  // get query string from url (optional) or window
  var queryString = url ? url.split('?')[1] : window.location.search.slice(1);

  // we'll store the parameters here
  var obj = {};

  // if query string exists
  if (queryString) {

    // stuff after # is not part of query string, so get rid of it
    queryString = queryString.split('#')[0];

    // split our query string into its component parts
    var arr = queryString.split('&');

    for (var i = 0; i < arr.length; i++) {
      // separate the keys and the values
      var a = arr[i].split('=');

      // set parameter name and value (use 'true' if empty)
      var paramName = a[0];
      var paramValue = typeof (a[1]) === 'undefined' ? true : a[1];

 
      if (typeof paramValue === 'string') paramValue = paramValue;

      // if the paramName ends with square brackets, e.g. colors[] or colors[2]
      if (paramName.match(/\[(\d+)?\]$/)) {

        // create key if it doesn't exist
        var key = paramName.replace(/\[(\d+)?\]/, '');
        if (!obj[key]) obj[key] = [];

        // if it's an indexed array e.g. colors[2]
        if (paramName.match(/\[\d+\]$/)) {
          // get the index value and add the entry at the appropriate position
          var index = /\[(\d+)\]/.exec(paramName)[1];
          obj[key][index] = paramValue;
        } else {
          // otherwise add the value to the end of the array
          obj[key].push(paramValue);
        }
      } else {
        // we're dealing with a string
        if (!obj[paramName]) {
          // if it doesn't exist, create property
          obj[paramName] = paramValue;
        } else if (obj[paramName] && typeof obj[paramName] === 'string'){
          // if property does exist and it's a string, convert it to an array
          obj[paramName] = [obj[paramName]];
          obj[paramName].push(paramValue);
        } else {
          // otherwise add the property
          obj[paramName].push(paramValue);
        }
      }
    }
  }

  return obj;
}



 window.onload = cargarMapa();




    </script>

<script>
  
  function cerrarSesion(){

  var r = confirm("¿Estas seguro que quieres cerrar sesión?");

  if (r == true) {
          firebase.auth().signOut().then(function() {
           // Sign-out successful.
            }).catch(function(error) {
            // An error happened.
            });
  } else {


  }

}


</script>


   

</script>



    <script>

  

</script>


  </body>
</html>
